groups:
  - name: dharma-recording-rules
    interval: 30s
    rules:
      # HTTP request rate rules
      - record: dharma:http_requests:rate5m
        expr: rate(http_requests_total[5m])

      - record: dharma:http_requests:rate1h
        expr: rate(http_requests_total[1h])

      # Error rate rules
      - record: dharma:http_errors:rate5m
        expr: rate(http_requests_total{status=~"5.."}[5m])

      - record: dharma:http_error_rate:ratio5m
        expr: dharma:http_errors:rate5m / dharma:http_requests:rate5m

      # Response time rules
      - record: dharma:http_request_duration:p50_5m
        expr: histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))

      - record: dharma:http_request_duration:p95_5m
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

      - record: dharma:http_request_duration:p99_5m
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

      # Business metrics rules
      - record: dharma:posts_processed:rate5m
        expr: rate(posts_processed_total[5m])

      - record: dharma:posts_processed:rate1h
        expr: rate(posts_processed_total[1h])

      - record: dharma:bots_detected:rate5m
        expr: rate(bots_detected_total[5m])

      - record: dharma:bot_detection_rate:ratio5m
        expr: dharma:bots_detected:rate5m / dharma:posts_processed:rate5m

      - record: dharma:campaigns_detected:rate5m
        expr: rate(campaigns_detected_total[5m])

      - record: dharma:alerts_generated:rate5m
        expr: rate(alerts_generated_total[5m])

      # Resource utilization rules
      - record: dharma:cpu_usage:avg5m
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      - record: dharma:memory_usage:ratio
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes

      - record: dharma:disk_usage:ratio
        expr: 1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)

      # Database performance rules
      - record: dharma:db_connections:active
        expr: pg_stat_activity_count

      - record: dharma:db_query_duration:p95_5m
        expr: histogram_quantile(0.95, rate(pg_stat_statements_mean_time_bucket[5m]))

      # Cache performance rules
      - record: dharma:redis_hit_rate:ratio5m
        expr: rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))

      - record: dharma:redis_memory_usage:ratio
        expr: redis_memory_used_bytes / redis_memory_max_bytes

  - name: dharma-sla-recording-rules
    interval: 1m
    rules:
      # SLA tracking rules
      - record: dharma:sla_availability:ratio5m
        expr: rate(http_requests_total{status=~"2.."}[5m]) / rate(http_requests_total[5m])

      - record: dharma:sla_availability:ratio1h
        expr: rate(http_requests_total{status=~"2.."}[1h]) / rate(http_requests_total[1h])

      - record: dharma:sla_availability:ratio24h
        expr: rate(http_requests_total{status=~"2.."}[24h]) / rate(http_requests_total[24h])

      - record: dharma:sla_response_time:p95_5m
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

      - record: dharma:sla_response_time:p95_1h
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[1h]))

      - record: dharma:sla_response_time:p95_24h
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[24h]))

  - name: dharma-capacity-planning-rules
    interval: 5m
    rules:
      # Capacity planning rules
      - record: dharma:capacity_cpu:prediction_1h
        expr: predict_linear(dharma:cpu_usage:avg5m[30m], 3600)

      - record: dharma:capacity_memory:prediction_1h
        expr: predict_linear(dharma:memory_usage:ratio[30m], 3600)

      - record: dharma:capacity_requests:prediction_1h
        expr: predict_linear(dharma:http_requests:rate5m[30m], 3600)

      - record: dharma:capacity_posts:prediction_1h
        expr: predict_linear(dharma:posts_processed:rate5m[30m], 3600)