# Production Docker Compose configuration with secrets management
version: '3.8'

services:
  data-collection-service:
    environment:
      # Use Docker secrets for API credentials in production
      - SERVICE_NAME=data-collection-service
      - USE_DOCKER_SECRETS=true
      - TWITTER_API_KEY_FILE=/run/secrets/twitter_api_key
      - TWITTER_API_SECRET_FILE=/run/secrets/twitter_api_secret
      - TWITTER_BEARER_TOKEN_FILE=/run/secrets/twitter_bearer_token
      - TWITTER_ACCESS_TOKEN_FILE=/run/secrets/twitter_access_token
      - TWITTER_ACCESS_TOKEN_SECRET_FILE=/run/secrets/twitter_access_token_secret
      - YOUTUBE_API_KEY_FILE=/run/secrets/youtube_api_key
      - TELEGRAM_BOT_TOKEN_FILE=/run/secrets/telegram_bot_token
    volumes:
      - ./shared:/app/shared:ro
      - ./scripts:/app/scripts:ro
    secrets:
      - twitter_api_key
      - twitter_api_secret
      - twitter_bearer_token
      - twitter_access_token
      - twitter_access_token_secret
      - youtube_api_key
      - telegram_bot_token
    healthcheck:
      test: ["CMD", "python", "/app/scripts/validate_credentials.py"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s

  ai-analysis-service:
    environment:
      - SERVICE_NAME=ai-analysis-service
      - USE_DOCKER_SECRETS=true
      - JWT_SECRET_KEY_FILE=/run/secrets/jwt_secret_key
      - ENCRYPTION_KEY_FILE=/run/secrets/encryption_key
    volumes:
      - ./shared:/app/shared:ro
      - ./models:/app/models:ro
      - ./scripts:/app/scripts:ro
    secrets:
      - jwt_secret_key
      - encryption_key
    healthcheck:
      test: ["CMD", "python", "/app/scripts/validate_credentials.py"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s

  api-gateway-service:
    environment:
      - SERVICE_NAME=api-gateway-service
      - USE_DOCKER_SECRETS=true
      - JWT_SECRET_KEY_FILE=/run/secrets/jwt_secret_key
      - ENCRYPTION_KEY_FILE=/run/secrets/encryption_key
    volumes:
      - ./shared:/app/shared:ro
      - ./scripts:/app/scripts:ro
    secrets:
      - jwt_secret_key
      - encryption_key
    healthcheck:
      test: ["CMD", "python", "/app/scripts/validate_credentials.py"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s

  dashboard-service:
    environment:
      - SERVICE_NAME=dashboard-service
      - USE_DOCKER_SECRETS=true
      - JWT_SECRET_KEY_FILE=/run/secrets/jwt_secret_key
    volumes:
      - ./shared:/app/shared:ro
      - ./scripts:/app/scripts:ro
    secrets:
      - jwt_secret_key
    healthcheck:
      test: ["CMD", "python", "/app/scripts/validate_credentials.py"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s

secrets:
  # Twitter API credentials
  twitter_api_key:
    external: true
    name: dharma_twitter_api_key
  twitter_api_secret:
    external: true
    name: dharma_twitter_api_secret
  twitter_bearer_token:
    external: true
    name: dharma_twitter_bearer_token
  twitter_access_token:
    external: true
    name: dharma_twitter_access_token
  twitter_access_token_secret:
    external: true
    name: dharma_twitter_access_token_secret
  
  # YouTube API credentials
  youtube_api_key:
    external: true
    name: dharma_youtube_api_key
  
  # Telegram API credentials
  telegram_bot_token:
    external: true
    name: dharma_telegram_bot_token
  
  # System secrets
  jwt_secret_key:
    external: true
    name: dharma_jwt_secret_key
  encryption_key:
    external: true
    name: dharma_encryption_key